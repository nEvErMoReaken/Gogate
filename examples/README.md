# 协议解析器配置文档

## 1. 配置文件概述

协议解析器配置使用YAML格式定义数据帧的解析结构和处理逻辑。通过配置，您可以定义字节流如何被分段处理、变量如何提取、设备数据点如何生成，以及处理流程如何根据条件路由。

## 2. 基本结构

配置文件结构为一个顶层键（协议名）包含一个列表，列表中每项定义一个处理节点（Section或Skip）：

```yaml
协议名:
  - desc: "第一个处理节点"
    size: 4
    # 更多字段...
  - skip: 3  # Skip节点
  - desc: "第三个处理节点"
    size: 2
    # 更多字段...
```

## 3. Section节点配置

Section是基本处理单元，处理固定大小的字节段：

| 字段 | 类型 | 说明 |
|------|------|------|
| desc | 字符串 | 节点描述，用于日志和调试 |
| size | 整数 | 处理的字节数量 |
| Dev | 映射 | 设备数据字段定义 |
| Vars | 映射 | 变量定义 |
| Label | 字符串 | 标签，用于路由跳转目标 |
| Next | 列表 | 路由规则 |

### 3.1 Dev字段

定义设备和其字段，支持多设备：

```yaml
Dev:
  设备名1:
    字段名1: "表达式1"  # 如 "Bytes[0]"
    字段名2: "表达式2"  # 如 "Bytes[1] + 10"
  设备名2:
    字段名a: "表达式a"
```

### 3.2 Vars字段

定义数据处理中的变量：

```yaml
Vars:
  变量名1: "表达式1"  # 如 "Bytes[2]"
  变量名2: "表达式2"  # 如 "Vars.变量名1 * 2"
```

### 3.3 表达式语法

- `Bytes[i]`：引用当前节点数据的第i个字节
- `Vars.变量名`：引用已定义的变量
- 支持算术运算：+, -, *, /, %
- 支持比较运算：==, !=, >, <, >=, <=
- 支持逻辑运算：&&, ||, !

### 3.4 Label和Next字段

Label定义节点标签，Next定义基于条件的路由规则：

```yaml
Label: "标签名"
Next:
  - condition: "条件表达式"  # 如 "Vars.type == 0x01"
    target: "目标标签"
  - condition: "另一个条件"
    target: "另一个目标"
```

目标标签可以是：
- 其他节点的Label值
- "END"：结束处理
- "DEFAULT"：默认下一个节点

## 4. Skip节点配置

Skip节点用于跳过指定数量的字节：

```yaml
skip: 3  # 跳过3个字节
```

## 5. 动态设备名

支持使用变量构建设备名：

```yaml
Dev:
  "设备${index}":  # 如 index=5 则生成 "设备5"
    字段: "Bytes[0]"
```

## 6. 循环处理

可以通过变量和条件路由实现循环处理：

1. 初始化循环变量
2. 设置循环开始节点的标签
3. 设置循环条件和目标
4. 处理循环体
5. 在循环结束节点使用条件路由

## 7. 配置示例

请参考 `examples/protocol/protocol_example.yml` 文件查看详细示例。

## 8. 最佳实践

1. **合理分段**：根据协议划分合理的处理段
2. **有意义的标签**：使用描述性强的标签名
3. **维护变量**：清晰定义和更新变量
4. **详细注释**：在desc字段提供充分描述
5. **正确的缩进**：保持YAML格式一致性，避免混用制表符和空格
6. **测试验证**：编写测试验证配置正确性，确保所有路径都被测试到

## 9. 常见问题排查

1. YAML解析错误：检查缩进、确保未混用制表符与空格
2. 路由不生效：检查条件表达式、验证标签定义
3. 循环问题：确认循环变量正确递增/递减、路由条件准确
4. 动态名称失败：验证变量已定义、模板格式正确

通过合理配置，您可以实现复杂的字节流协议解析，包括分支逻辑、循环结构和动态处理流程。
